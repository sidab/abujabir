<template>

    <div class="page">

        <div class="navbar no-shadow">

            <div class="navbar-inner sliding">

                <div class="left">

                    <a href="#" class="link back">

                        <i class="icon icon-back"></i>

                    </a>

                </div>

                <div class="title">{{book.Название}}</div>

                <div class="right">

                    <a href="#" class="link download-all">

                        <i class="icon f7-icons">download</i>

                    </a>

                </div>



            </div>

        </div>

        {{#if book.Вырезки}}

            <div class="subnavbar">

                <div class="subnavbar-inner">

                    <div class="segmented segmented-raised">

                        <a class="button tab-link tab-link-active" href="#uroki">Уроки</a>
                        <a class="button tab-link" href="#virezki">Вырезки</a>

                    </div>

                </div>

            </div>

        {{/if}}

        <div class="page-content">

            <div class="tabs">

                <div class="tab tab-active" id="uroki">

                    <div class="list">

                <ul>

                    {{#each book.Аудио}}

                        <li data-index="{{@index}}" class="audio">

                            <div class="item-content">

                                <div class="item-media">

                                    <i class="icon f7-icons">play</i>

                                </div>

                                <div class="item-inner">

                                    <div class="item-title">{{Название}}</div>

                                    <div class="item-after">

                                        <span class="duration">{{Длительность}}</span>

                                        <i class="icon f7-icons download">download</i>
                                        <i class="icon f7-icons downloaded text-color-green display-none">check_round_fill</i>

                                        <div class="gauge gauge-progress"></div>

                                    </div>

                                </div>

                            </div>

                        </li>

                    {{/each}}

                </ul>

            </div>

                </div>

                <div class="tab" id="virezki">

                    <div class="list accordion-list">

                        <ul>

                            {{#each book.Аудио}}

                                {{#if Вырезки}}

                                    <li class="accordion-item accordion-item-opened">

                                        <a href="#" class="item-content item-link">

                                            <div class="item-inner">

                                                <div class="item-title">{{Название}}</div>

                                            </div>

                                        </a>

                                        <div class="accordion-item-content">

                                            <div class="list">

                                                <ul>

                                                    {{#each Вырезки}}

                                                        <li data-index-parent="{{../@index}}" data-index="{{@index}}" class="audio audio-child">

                                                        <div class="item-content">

                                                            <div class="item-media">

                                                                <i class="icon f7-icons">play</i>

                                                            </div>

                                                            <div class="item-inner">

                                                                <div class="item-title">{{Название}}</div>

                                                                <div class="item-after">

                                                                    <span class="duration">{{Длительность}}</span>

                                                                    <i class="icon f7-icons download">download</i>
                                                                    <i class="icon f7-icons downloaded text-color-green display-none">check_round_fill</i>

                                                                    <div class="gauge gauge-progress"></div>

                                                                </div>

                                                            </div>

                                                        </div>

                                                    </li>

                                                    {{/each}}

                                                </ul>

                                            </div>

                                        </div>

                                    </li>

                                {{/if}}

                            {{/each}}

                        </ul>

                    </div>

                </div>

            </div>

        </div>

    </div>

</template>

<style scoped>

    .icon {

    }

    .accordion-item-content .list ul {
        background: #eee;
    }
    .downloaded {
        padding-top: 4px;
    }

    .download, .downloaded {
        width: 35px;
    }

    .gauge-progress {
        height: 35px;
    }

    .navbar .back {
        margin-left: -8px;
    }

    .navbar .download-all {
        margin-right: -8px;
    }

    .navbar .icon {
        width: 50px;
        line-height: 49px;
        height: 49px;
    }

    .duration {
        padding-top: 5px;
        padding-right: 10px;
    }

    .item-title {
        white-space: normal;
    }

</style>

<script>

    return {

        data: function () {

            var id = this.$route.params.id;

            return {
                book: app.methods.books(id)
            };

        },
        methods: {

        },
        on: {

            pageInit: function() {

                var component = this;
                var page = component.$el;

                localforage.keys().then(function(keys) {

                    page.find('.audio').each(function () {

                        var $this = $$(this);
                        var index = $this.data('index');
                        var url;

                        if ($this.hasClass('audio-child')) {

                            var indexParent = $this.data('index-parent');

                            url = component.book.Аудио[indexParent].Вырезки[index].Ссылка;

                        } else {

                            url = component.book.Аудио[index].Ссылка;

                        }

                        if (keys.indexOf(url) !== -1)  {

                            $this.find('.download').addClass('display-none');
                            $this.find('.downloaded').removeClass('display-none');

                        }

                    });

                });

                page.find('.download-all').on('click', function () {

                    app.dialog.confirm('Вы уверены что хотите скачать все аудиозаписи?', 'Внимание', function () {

                        page.find('.download:not(.display-none)').click();

                    });

                });

                page.find('.audio').on('click', function (e) {

                    var $this = $$(this);
                    var index = $this.data('index');

                    if ($this.hasClass('audio-child')) {

                        var indexParent = $this.data('index-parent');

                    }

                    if ($$(e.target).hasClass('download')) {

                        $this.find('.download').addClass('display-none');

                        var gaugeEl = $this.find('.gauge');

                        var gauge = app.gauge.create({
                            el: gaugeEl,
                            type: 'circle',
                            value: 0,
                            size: 35,
                            borderColor: '#2196f3',
                            borderWidth: 4,
                            valueText: '0%',
                            valueFontSize: 10,
                            valueTextColor: '#2196f3'
                        });

                        var url;

                        if ($this.hasClass('audio-child')) {

                            url = component.book.Аудио[indexParent].Вырезки[index].Ссылка;

                        } else {

                            url = component.book.Аудио[index].Ссылка;

                        }

                        var request = app.request({
                            url: encodeURI(app.params.backend + url),
                            xhrFields: {
                                responseType: 'blob'
                            },
                            success: function (blob) {

                                localforage.setItem(url, blob).then(function () {

                                    $this.find('.downloaded').removeClass('display-none');
                                    gauge.destroy();

                                });

                            }
                        });

                        request.addEventListener('progress', function (progress) {

                            var progress = (progress.loaded / progress.total) * 100;

                            gauge.update({
                                value: progress / 100,
                                valueText: progress.toFixed(0) + '%'
                            });

                        }, false);

                    } else {

                        if ($this.hasClass('audio-child')) {

                            var audio = {
                                title: component.book.Название + ' - ' + component.book.Аудио[indexParent].Название + ' - ' + component.book.Аудио[indexParent].Вырезки[index].Название,
                                author: component.book.Автор,
                                url: component.book.Аудио[indexParent].Вырезки[index].Ссылка,
                                duration: component.book.Аудио[indexParent].Вырезки[index].Длительность
                            };

                        } else {

                            var audio = {
                                title: component.book.Название + ' - ' + component.book.Аудио[index].Название,
                                author: component.book.Автор,
                                url: component.book.Аудио[index].Ссылка,
                                duration: component.book.Аудио[index].Длительность
                            };

                        }

                        app.methods.player.play(audio);

                    }

                });


            }

        }

    }

</script>